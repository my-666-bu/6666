<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>控制器详情</title>
    <link rel="stylesheet" href="/static/style.css?v=20250915">
</head>
<body>
    <div class="top-nav">
        <div class="logo">物联网云平台</div>
        <div class="nav-links">
            <a href="/">首页</a>
            <a href="#" class="active">控制器</a>
        </div>
    </div>

    <div class="sensor-header">
        <div class="sensor-info">
            <h1>{{ device.name }}</h1>
            <p class="sensor-id">设备ID: {{ device.id }}</p>
        </div>
        <div class="sensor-actions">
            <button id="backBtn">返回首页</button>
        </div>
    </div>

    <div class="module-container">
        <h2>开关控制</h2>
        <p class="sensor-id">控制器标识: {{ device.controller_key or '—' }}</p>
        <div style="display:flex; gap:14px; align-items:center;">
            <label style="font-size:16px;">执行器
                <input type="checkbox" id="actSwitch" {{ 'checked' if device.state else '' }} />
            </label>
        </div>
    </div>

    <script>
        const deviceId = '{{ device.id }}';
        document.getElementById('backBtn').addEventListener('click', () => {
            window.location.href = '/';
        });

        const actSwitch = document.getElementById('actSwitch');
        function toggle(state) {
            actSwitch.disabled = true;
            const prev = !state;
            fetch(`/api/controllers/${deviceId}/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ state })
            }).then(r => r.json()).then(d => {
                if (d.code !== 200) {
                    alert('更新失败: ' + d.msg);
                    actSwitch.checked = prev;
                }
            }).catch(() => {
                alert('网络错误');
                actSwitch.checked = prev;
            }).finally(() => {
                actSwitch.disabled = false;
            });
        }
        actSwitch.addEventListener('change', (e) => toggle(e.target.checked));
    </script>
</body>
</html>


